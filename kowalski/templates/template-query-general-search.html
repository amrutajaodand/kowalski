{% extends "template.html" %}

{% block css %}
    <style>
        .form-group {
            margin-bottom:5px !important;
            margin-top: 2px !important;
        }
    </style>
{% endblock %}

{% block nav_query %}
    active
{% endblock %}

{% block body %}

    <div class="container">

        <h2>Query the databases</h2><br>

        <div id="accordion" role="tablist">
            <div class="card">
                <div class="card-header" role="tab" id="headingCoordinatesTab">
                    <h5 class="mb-0">
                        <a data-toggle="collapse" href="#coordinatesTab" aria-expanded="true"
                           aria-controls="coordinatesTab">
                            General search
                        </a>
                    </h5>
                </div>
                <div id="coordinatesTab" class="collapse show" role="tabpanel" aria-labelledby="headingCoordinatesTab">
                    <div class="card-body">
                        <form id="objects_form" class="form">

                            <div class="form-group row">
                                <label for="ra" class="col-md-2 col-form-label">Query</label>
                                <div class="col-md-10">
                                    <textarea class="form-control form-control-sm query" id="query" name="query"
                                              placeholder="Query in pymongo format. Refer to tutorials for details and examples."
                                              rows="5"></textarea>
                                </div>
                            </div>

                        </form>
                    </div>
                </div>
            </div>


        </div>

        <br>
        <input class="btn btn-outline-primary" id="get_query" type="submit" value="Get query">
        <input class="btn btn-primary" id="submit_query" type="submit" value="Submit">

    </div>

{% endblock %}

{% block js %}

        <script>
        // generate "random" 32-symbol string:
        function random_string() {
            return Math.random().toString(36).substr(2, 7) + Math.random().toString(36).substr(2, 7) +
                Math.random().toString(36).substr(2, 7) + Math.random().toString(36).substr(2, 7) +
                Math.random().toString(36).substr(2, 4);
        }
        // construct query in JSON format
        function construct_query() {
            var query = {};
            // other queries will be added in the future
            query['query_type'] = 'general_search';
            // serialize object query
            query['query'] = $("#query").val();
            {#// season with some salt:#}
            {#query['kwargs'] = {};#}
            {#query['kwargs']['_id'] = random_string();#}
            return query;
        }
        // get query in JSON format
        $(document).ready(function() {
            $('#get_query').click(function () {
                var query = construct_query();
                bootbox.alert(JSON.stringify(query, null, 4));
            });
        });
        // submit query
        $(document).ready(function() {
            $('#submit_query').click(function () {
                bootbox.confirm({
                    message: "Do you want to submit the query?",
                    buttons: {
                        cancel: {
                            label: '<i class="fa fa-times"></i> Cancel'
                        },
                        confirm: {
                            label: '<i class="fa fa-check"></i> Confirm'
                        }
                    },
                    callback: function (result) {
                        // console.log('This was logged in the callback: ' + result);
                        // confirmed? emit request to server:
                        if (result) {
                            var query = construct_query();

                            // season query with some salt:
                            query['kwargs'] = {};
                            query['kwargs']['_id'] = random_string();
                            // do not wait for the result
                            query['kwargs']['enqueue_only'] = true;
                            {#console.log(JSON.stringify(query));#}

                            $.ajax({url: '{{-script_root-}}/web-query',
                                method: 'PUT',
                                data: JSON.stringify(query),
                                processData: false,
                                contentType: 'application/json',
                                success: function(data) {
                                    if (data['message'] === 'success') {
                                        {#location.reload(true);#}
                                        showFlashingMessage('Info:', 'Running query.', 'success');
                                    }
                                    else {
                                        $('#addUserModal').modal('hide');
                                        showFlashingMessage('Info:', 'Failed to run query: ' + data['message'], 'danger');
                                    }
                                },
                                error: function(data) {
                                    $('#addUserModal').modal('hide');
                                    showFlashingMessage('Info:', 'Failed to run query.', 'danger');
                                }
                            });
                            bootbox.hideAll();
                            return false;
                        }
                    }
                });
            });

        });
    </script>

    {# show flashing messages #}
    <script>
        function showFlashingMessage(title, message, type) {
            $.notify({title: title, message: message},
                {placement: {
                    from: "bottom",
                    align: "right"
                },
                    type: type,
                    template: '<div data-notify="container" class="col-xs-11 col-md-3 alert alert-{0}" role="alert" ' +
                    'style="max-width:400px; font-size: 0.75rem;">' +
                    '<button type="button" aria-hidden="true" class="close" data-notify="dismiss">Ã—</button>' +
                    '<span data-notify="icon"></span> ' +
                    '<span data-notify="title">{1}</span> ' +
                    '<span data-notify="message">{2}</span>' +
                    '<div class="progress" data-notify="progressbar">' +
                    '<div class="progress-bar progress-bar-{0}" role="progressbar" aria-valuenow="0" ' +
                    'aria-valuemin="0" aria-valuemax="100" style="width: 0%;"></div>' +
                    '</div>' +
                    '<a href="{3}" target="{4}" data-notify="url"></a>' +
                    '</div>'
                                        });
        }
    </script>
{% endblock %}